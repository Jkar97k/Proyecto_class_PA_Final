import ujson
import urequests
import time
import network
import random

# ONFIGURACI√ìN 
WIFI_SSID = 'Wokwi-GUEST'
WIFI_PASS = ''

SERVER_URL = "https://8423ecfd-f092-4e20-8fab-219d18f035e6-00-25frin13h2g1f.spock.replit.dev/receive_sensor_data"



def connect_wifi():
    
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    if not wlan.isconnected():
        print(f'Conectando a red: {WIFI_SSID}')
        wlan.connect(WIFI_SSID, WIFI_PASS)
        timeout = 30
        while not wlan.isconnected() and timeout > 0:
            time.sleep(1)
            print('.')
            timeout -= 1
        
        if wlan.isconnected():
            print('WiFi Conectado')
            print('Configuraci√≥n de red:', wlan.ifconfig())
        else:
            print('Error de conexi√≥n WiFi.')
            return None
    return wlan

def read_simulated_data(sensor_type):
    """Simula la lectura de datos del sensor."""
    if sensor_type == "Temperature":
        # Temperatura entre 20.0 y 35.9
        value = random.uniform(20.0, 36.0)
        return round(value, 1), "C"
    elif sensor_type == "Humidity":
        # Humedad entre 40.0 y 70.9
        value = random.uniform(40.0, 71.0)
        return round(value, 1), "%"
    return None, None

def send_data(sensor_type):
    value, unit = read_simulated_data(sensor_type)
    if value is None:
        print(f"Error: Tipo de sensor desconocido: {sensor_type}")
        return

    payload_data = {
        "sensor_type": sensor_type,
        "value": value,
        "unit": unit
    }
    
    # Serializar el payload a JSON
    json_payload = ujson.dumps(payload_data)
    
    print("\n--- Enviando Datos ---")
    print(f"Payload JSON: {json_payload}")

    try:
        # Definir los encabezados (importante para Flask)
        headers = {'Content-Type': 'application/json'}
        
        # Realizar la petici√≥n POST
        response = urequests.post(
            SERVER_URL, 
            data=json_payload, 
            headers=headers
        )

        # Manejar la respuesta
        if response.status_code == 201:
            print(f"[{sensor_type}] √âXITO: C√≥digo 201. Dato guardado en MongoDB.")
        else:
            print(f"ERROR: C√≥digo de respuesta HTTP: {response.status_code}")
            # Mostrar la respuesta completa para debugging
            print(f"Respuesta del Servidor: {response.text}")

        response.close() # Cierra la conexi√≥n

    except Exception as e:
        print(f"ERROR al realizar la petici√≥n HTTP: {e}")


def main():
    
    # Conectar a Wi-Fi una vez
    if connect_wifi():
        while True:
           
            send_data("Temperature")
            time.sleep(2)
            send_data("Humidity")

            # Esperar 15 segundos antes de la siguiente ronda de env√≠os
            print("\nEsperando 15 segundos...")
            time.sleep(15)

if __name__ == '__main__':
    main()

import network
import urequests
import ujson
import time
import random

# --- CONFIGURACI√ìN ---
WIFI_SSID = 'Wokwi-GUEST'
WIFI_PASS = ''
SERVER_URL = "https://8423ecfd-f092-4e20-8fab-219d18f035e6-00-25frin13h2g1f.spock.replit.dev/receive_sensor_data"


# --- CONECTAR WIFI ---
def connect_wifi():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    if not wlan.isconnected():
        print('üîå Conectando a WiFi...')
        wlan.connect(WIFI_SSID, WIFI_PASS)
        timeout = 60
        while not wlan.isconnected() and timeout > 0:
            print('.', end='')
            time.sleep(1)
            timeout -= 1
        print()
    if wlan.isconnected():
        print('‚úÖ WiFi Conectado')
        print('Configuraci√≥n de red:', wlan.ifconfig())
        return True
    else:
        print('‚ùå No se pudo conectar a WiFi')
        return False


# --- GENERAR HORA ALEATORIA (ISO) ---
def hora_random_iso():
    """Devuelve la fecha actual con hora/minuto/segundo aleatorios en formato ISO."""
    t = time.localtime()
    random_hour = random.randint(0, 23)
    random_min = random.randint(0, 59)
    random_sec = random.randint(0, 59)
    fecha = "%04d-%02d-%02dT%02d:%02d:%02d" % (t[0], t[1], t[2], random_hour, random_min, random_sec)
    return fecha


# --- ENVIAR DATOS ---
def send_sensor_data(sensor_id):
    """Env√≠a los datos simulados de un sensor."""
    estado = random.choice([0, 1])
    tipo_ejecucion = hora_random_iso()

    payload = {
        "codigosensor": sensor_id,
        "estado": estado,
        "TipoEjecucion": tipo_ejecucion
    }

    print("\nüì§ Enviando Sensor", sensor_id, "->", payload)

    try:
        headers = {'Content-Type': 'application/json'}
        response = urequests.post(SERVER_URL, data=ujson.dumps(payload), headers=headers)

        if response.status_code == 201:
            print("‚úÖ Sensor", sensor_id, "guardado correctamente en MongoDB")
        else:
            print("‚ö†Ô∏è Error:", response.status_code, response.text)

        response.close()

    except Exception as e:
        print("‚ùå Error al enviar datos:", e)


# --- LOOP PRINCIPAL ---
def main():
    if connect_wifi():
        while True:
            for sensor_id in range(1, 4):  # Tres sensores
                send_sensor_data(sensor_id)
                time.sleep(1)  # peque√±a pausa entre sensores

            print("\n‚è± Esperando 15 segundos antes del siguiente env√≠o...\n")
            time.sleep(15)


# --- EJECUTAR ---
main()

# proxy https://replit.com/@jgarcia861/ProxySensorData



docker compose down -v --remove-orphans
